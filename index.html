<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ブラウザで動画圧縮（ffmpeg.wasm）</title>
  <script type="module">
    import { createFFmpeg, fetchFile } from 'https://unpkg.com/@ffmpeg/ffmpeg@0.12.2/dist/ffmpeg.min.js';

    const ffmpeg = createFFmpeg({ log: true });

    async function runFFmpeg(file, preset) {
      const log = document.getElementById('log');
      log.textContent = '準備中...';

      if (!ffmpeg.isLoaded()) {
        log.textContent = 'FFmpegをロード中...';
        await ffmpeg.load();
      }

      log.textContent = 'ファイル読み込み中...';
      ffmpeg.FS('writeFile', 'input.mp4', await fetchFile(file));

      let command;
      let outputName;
      switch (preset) {
        case 'x264':
          command = ['-i', 'input.mp4', '-c:v', 'libx264', '-preset', 'slow', '-crf', '23', '-pix_fmt', 'yuv420p10le', '-c:a', 'aac', '-ar', '44100', '-b:a', '128k', 'output.mp4'];
          outputName = 'output.mp4';
          break;
        case 'amf':
          command = ['-i', 'input.mp4', '-c:v', 'libvpx', '-b:v', '1M', '-c:a', 'libvorbis', 'output.webm'];
          outputName = 'output.webm';
          break;
        case 'svt':
          command = ['-i', 'input.mp4', '-c:v', 'libvpx-vp9', '-crf', '35', '-b:v', '0', '-c:a', 'libopus', 'output.webm'];
          outputName = 'output.webm';
          break;
        default:
          alert('不明なプリセットです');
          return;
      }

      log.textContent = '圧縮中...（お待ちください）';
      await ffmpeg.run(...command);

      log.textContent = '出力ファイル生成中...';
      const data = ffmpeg.FS('readFile', outputName);
      const blob = new Blob([data.buffer], { type: outputName.endsWith('.mp4') ? 'video/mp4' : 'video/webm' });
      const url = URL.createObjectURL(blob);

      const a = document.createElement('a');
      a.href = url;
      a.download = outputName;
      a.textContent = '圧縮済みファイルをダウンロード';
      document.body.appendChild(a);

      log.textContent = '完了しました！';
    }

    window.handleFile = () => {
      const file = document.getElementById('video').files[0];
      const preset = document.getElementById('preset').value;
      if (!file) {
        alert('ファイルを選択してください');
        return;
      }
      runFFmpeg(file, preset);
    };
  </script>
</head>
<body>
  <h2>ブラウザだけで動画圧縮（ffmpeg.wasm）</h2>
  <label for="preset">圧縮プリセット：</label>
  <select id="preset">
    <option value="x264">高品質（x264）</option>
    <option value="amf">標準圧縮（VP8/AMF代用）</option>
    <option value="svt">高圧縮（VP9/SVT代用）</option>
  </select>
  <br><br>
  <input type="file" id="video" accept="video/*">
  <button onclick="handleFile()">圧縮開始</button>
  <pre id="log">ステータス表示欄</pre>
</body>
</html>
